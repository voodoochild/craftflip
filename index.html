<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://d1h9a8s8eodvjz.cloudfront.net/fonts/menomonia/08-02-12/menomonia.css">
  <meta charset="utf-8">
  <title>Craft Flip</title>
  <style>
* {
  box-sizing: border-box;
}
body {
  color: #333;
  font-family: menomonia;
  font-size: 16px;
}
h1 {
  font-size: 3rem;
  margin: 20px 10px;
}
.recipe {
  border: 2px solid #dedede;
  margin: 5px 15px 20px;
  padding: 10px;
  width: 500px;
}
.recipe h1 {
  font-size: 1.25rem;
  margin: 0;
}
.profit {
  background: #6ec962;
  color: #fff;
  display: inline-block;
  float: right;
  font-size: .9rem;
  padding: 2px 4px;
}
.disciplines {
  font-size: .75rem;
}
.recipe h2 {
  font-size: 1rem;
}
li b {
  font-size: .9rem;
  float: right;
  line-height: 1.35;
}
</style>
</head>
<body>
  <h1>Craft Flip</h1>
  <main></main>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
  <script type="text/javascript">
  /**
 * Round a float to two decimal places.
 */
function rounded (num) {
  var sign = num >= 0 ? 1 : -1;
  return (Math.round((num * Math.pow(10, 2)) + (sign  *0.001)) / Math.pow(10, 2)).toFixed(2);
}


/**
 * Render a recipe to the console.
 * @TODO - change args to options object
 */
function render (recipe, count, buy, craft) {
  count = count || 1;

  var name = recipe.output_item.name;
  var prices = recipe.output_item.prices;

  if (prices && prices.sell) {
    if (prices.crafted && prices.crafted < prices.sell) {
      craft.push({ recipe: recipe, count: count });
    } else {
      buy.push({ recipe: recipe, count: count });
    }
  }
  
  if (recipe.ingredients && recipe.ingredients.length) {
    _.forEach(recipe.ingredients, function (ingredient) {
      if (!ingredient.recipe || ingredient.item.acquisition !== 'craft') {
        ingredient.recipe = { output_item: ingredient.item };
      }
      render(ingredient.recipe, ingredient.count, buy, craft);
    });
  }
}


/**
 * Get profitable recipes and render.
 */
// $.getJSON('http://jsbin.com/seram/2/js').then(function (data) {
$.getJSON('http://localhost:3000/profits.json').then(function (data) {
  _.forEach(data.recipes, function (recipe) {
    
    var html = '<article class="recipe"><header>';
    
    html += '<h1><a href="http://www.gw2tp.com/item/'+ recipe.output_item_id +'">'+
      recipe.output_item.name +'</a>'+
      ' <span class="profit">'+ rounded(recipe.output_item.spread/100) +
      '</span></h1>';
   
    html += '<span class="disciplines">'+ recipe.disciplines.join(', ') +
      ' <b>'+ recipe.min_rating +'</b></span></header>';
                  
    html += '<p>Craft for <b>'+ rounded(recipe.output_item.prices.crafted / 100) +
      '</b>, sell for <b>'+ rounded(recipe.output_item.prices.buy / 100) +'</b>';
    
    var buy = [];
    var craft = [];
    
    render(recipe, 1, buy, craft);
    
    html += '<h2>Buy:</h2><ul>';
    _.forEach(buy.reverse(), function (r) {
      html += '<li><a href="http://www.gw2tp.com/item/'+ r.recipe.output_item.item_id +'">'+
        r.recipe.output_item.name +'</a> x '+ r.count +
        ' <b>'+ rounded((r.recipe.output_item.prices.sell * r.count)/100) +'</b></li>';
    });
    html += '</ul>';
    
    html += '<h2>Craft:</h2><ul>';
    _.forEach(craft.reverse(), function (r) {
      html += '<li><a href="http://www.gw2tp.com/item/'+ r.recipe.output_item.item_id +'">'+
        r.recipe.output_item.name +'</a> x '+ r.count + '</li>';
    });
    html += '</ul>';
    
    
    html += '</article>';
    $('main').append(html);
  });
});
  </script>
</body>
</html>